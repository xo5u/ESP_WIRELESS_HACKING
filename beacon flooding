// ESP32 SSID Cycler - visibility tuned (lab testing only)
// Use only on hardware/networks you own or in an isolated lab.
// Key ideas: fixed channel, distinct SSID suffixes, and a cooldown
// so the radio can reconfigure before the next SSID.

#include <WiFi.h>
#include "esp_wifi.h"   // for esp_wifi_set_channel

// CONFIG
const bool USE_WPA = false;           // set true if you want WPA2 test APs
const char* WPA_PASS = "testing123";  // used if USE_WPA==true

const int GENERATED_COUNT = 60;       // how many SSIDs to generate
const unsigned long intervalMs = 3000; // dwell time per SSID (ms)
const int FIXED_CHANNEL = 1;          // choose 1, 6 or 11
const int COOLDOWN_MS = 400;          // cooldown after stopping AP

String generatedSSIDs[GENERATED_COUNT];
unsigned long lastSwitch = 0;
int currentIndex = 0;

void setWifiChannel() {
  esp_err_t err = esp_wifi_set_channel(FIXED_CHANNEL, WIFI_SECOND_CHAN_NONE);
  if (err != ESP_OK) {
    Serial.printf("Warning: esp_wifi_set_channel failed: %d\n", err);
  } else {
    Serial.printf("Set channel %d\n", FIXED_CHANNEL);
  }
}

bool startAP(const char* ssid) {
  WiFi.mode(WIFI_AP);
  delay(10);
  bool ok = USE_WPA ? WiFi.softAP(ssid, WPA_PASS) : WiFi.softAP(ssid);
  if (!ok) {
    Serial.printf("ERROR: softAP failed for '%s'\n", ssid);
    return false;
  }
  setWifiChannel(); // ensure radio settings applied after starting AP
  IPAddress ip = WiFi.softAPIP();
  Serial.printf("Started AP: '%s' (IP %s)\n", ssid, ip.toString().c_str());
  return true;
}

void stopAP() {
  WiFi.softAPdisconnect(true);
  delay(10);
  Serial.println("softAP stopped.");
}

void restartAP(const char* ssid) {
  stopAP();
  delay(COOLDOWN_MS);   // give radio time to reconfigure
  startAP(ssid);
}

void setup() {
  Serial.begin(115200);
  delay(200);
  Serial.println("\n=== SSID Cycler (visibility-tuned) ===");
  Serial.printf("Generating %d SSIDs, interval %lums, channel %d\n",
                GENERATED_COUNT, intervalMs, FIXED_CHANNEL);
  if (USE_WPA) Serial.println("WPA mode: ON");
  else Serial.println("WPA mode: OFF (open APs)");

  // populate generated SSIDs with distinct suffixes
  randomSeed(esp_random());
  for (int i = 0; i < GENERATED_COUNT; ++i) {
    int r = random(1000, 9999);
    generatedSSIDs[i] = "mr.shadow" + String(i + 1) + "_X" + String(r);
  }

  // print list for reference
  for (int i = 0; i < GENERATED_COUNT; ++i) {
    Serial.printf(" %3d: %s\n", i + 1, generatedSSIDs[i].c_str());
  }

  currentIndex = 0;
  startAP(generatedSSIDs[currentIndex].c_str());
  lastSwitch = millis();
}

void loop() {
  // serial stop for safety
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    if (cmd.equalsIgnoreCase("stop")) {
      stopAP();
      Serial.println("Stopped by user. Halting.");
      while (true) delay(1000);
    }
  }

  unsigned long now = millis();
  if (now - lastSwitch >= intervalMs) {
    currentIndex = (currentIndex + 1) % GENERATED_COUNT;
    Serial.printf("\nSwitching -> %d/%d : %s\n",
                  currentIndex + 1, GENERATED_COUNT,
                  generatedSSIDs[currentIndex].c_str());
    restartAP(generatedSSIDs[currentIndex].c_str());
    lastSwitch = now;
  }

  delay(10);
}
